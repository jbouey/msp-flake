{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://msp.internal/schemas/evidence-bundle-v1.json",
  "title": "HIPAA Compliance Evidence Bundle",
  "description": "Cryptographically-signed evidence of automated incident remediation",
  "type": "object",
  "required": [
    "bundle_id",
    "bundle_version",
    "client_id",
    "generated_at",
    "incident",
    "runbook",
    "execution",
    "actions_taken",
    "outputs",
    "evidence_bundle_hash"
  ],
  "properties": {
    "bundle_id": {
      "type": "string",
      "pattern": "^EB-[0-9]{8}-[0-9]{4}$",
      "description": "Unique bundle identifier (EB-YYYYMMDD-NNNN)"
    },
    "bundle_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "description": "Schema version (major.minor)"
    },
    "client_id": {
      "type": "string",
      "minLength": 1,
      "description": "Client identifier"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when bundle was generated"
    },
    "incident": {
      "type": "object",
      "required": [
        "incident_id",
        "event_type",
        "severity",
        "detected_at",
        "hostname",
        "hipaa_controls"
      ],
      "properties": {
        "incident_id": {
          "type": "string",
          "pattern": "^INC-[0-9]{8}-[0-9]{4}$",
          "description": "Unique incident identifier"
        },
        "event_type": {
          "type": "string",
          "enum": [
            "backup_failure",
            "backup_success",
            "cert_expiry",
            "cert_renewed",
            "disk_full",
            "disk_cleanup",
            "service_crash",
            "service_restart",
            "cpu_high",
            "cpu_normal",
            "memory_high",
            "memory_normal",
            "baseline_drift",
            "baseline_enforced",
            "patch_available",
            "patch_applied",
            "failed_login",
            "unauthorized_access",
            "firewall_blocked",
            "restore_test",
            "encryption_disabled",
            "encryption_enabled"
          ],
          "description": "Type of incident detected"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "info"],
          "description": "Incident severity level"
        },
        "detected_at": {
          "type": "string",
          "format": "date-time",
          "description": "When incident was first detected"
        },
        "hostname": {
          "type": "string",
          "minLength": 1,
          "description": "Affected system hostname"
        },
        "details": {
          "type": "object",
          "description": "Incident-specific details"
        },
        "hipaa_controls": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^164\\.[0-9]{3}\\([a-z]\\)(\\([0-9]\\))?(\\([a-z]{1,3}\\))?(\\([A-Z]\\))?$"
          },
          "minItems": 1,
          "description": "HIPAA Security Rule control citations (e.g., 164.308(a)(7)(ii)(A))"
        }
      }
    },
    "runbook": {
      "type": "object",
      "required": [
        "runbook_id",
        "runbook_version",
        "runbook_hash",
        "steps_total"
      ],
      "properties": {
        "runbook_id": {
          "type": "string",
          "pattern": "^RB-[A-Z]+-[0-9]{3}$",
          "description": "Runbook identifier (e.g., RB-BACKUP-001)"
        },
        "runbook_version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+$",
          "description": "Runbook version"
        },
        "runbook_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA256 hash of runbook YAML file"
        },
        "steps_total": {
          "type": "integer",
          "minimum": 1,
          "description": "Total number of steps in runbook"
        },
        "steps_executed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of steps actually executed"
        }
      }
    },
    "execution": {
      "type": "object",
      "required": [
        "timestamp_start",
        "timestamp_end",
        "operator",
        "mttr_seconds",
        "sla_met",
        "resolution_type"
      ],
      "properties": {
        "timestamp_start": {
          "type": "string",
          "format": "date-time",
          "description": "When remediation started"
        },
        "timestamp_end": {
          "type": "string",
          "format": "date-time",
          "description": "When remediation completed"
        },
        "operator": {
          "type": "string",
          "pattern": "^(service|user):[a-z0-9-]+$",
          "description": "Who/what performed remediation (service:mcp-executor or user:username)"
        },
        "mttr_seconds": {
          "type": "integer",
          "minimum": 0,
          "description": "Mean time to remediation in seconds"
        },
        "sla_target_seconds": {
          "type": "integer",
          "minimum": 0,
          "description": "SLA target for this severity level"
        },
        "sla_met": {
          "type": "boolean",
          "description": "Whether SLA was met"
        },
        "resolution_type": {
          "type": "string",
          "enum": ["auto", "manual", "partial"],
          "description": "How incident was resolved"
        }
      }
    },
    "actions_taken": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": [
          "step",
          "action",
          "script_hash",
          "result",
          "exit_code",
          "timestamp"
        ],
        "properties": {
          "step": {
            "type": "integer",
            "minimum": 1,
            "description": "Step number in sequence"
          },
          "action": {
            "type": "string",
            "minLength": 1,
            "description": "Action performed"
          },
          "script_hash": {
            "type": "string",
            "pattern": "^sha256:[a-f0-9]{64}$",
            "description": "SHA256 hash of script that executed"
          },
          "result": {
            "type": "string",
            "enum": ["ok", "failed", "skipped"],
            "description": "Step execution result"
          },
          "exit_code": {
            "type": "integer",
            "description": "Script exit code"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "When step executed"
          },
          "error_message": {
            "type": ["string", "null"],
            "description": "Error message if step failed"
          },
          "stdout_excerpt": {
            "type": ["string", "null"],
            "maxLength": 10000,
            "description": "Excerpt from stdout (truncated)"
          },
          "stderr_excerpt": {
            "type": ["string", "null"],
            "maxLength": 10000,
            "description": "Excerpt from stderr (truncated)"
          }
        }
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Additional evidence artifacts",
      "properties": {
        "log_excerpts": {
          "type": "object",
          "description": "Log file excerpts (truncated to reasonable size)",
          "additionalProperties": {
            "type": "string",
            "maxLength": 50000
          }
        },
        "checksums": {
          "type": "object",
          "description": "File checksums for verification",
          "additionalProperties": {
            "type": "string",
            "pattern": "^(sha256|md5):[a-f0-9]+$"
          }
        },
        "configurations": {
          "type": "object",
          "description": "Configuration snapshots",
          "additionalProperties": true
        },
        "outputs": {
          "type": "object",
          "description": "Remediation-specific outputs",
          "additionalProperties": true
        }
      }
    },
    "outputs": {
      "type": "object",
      "required": ["resolution_status"],
      "properties": {
        "resolution_status": {
          "type": "string",
          "enum": ["success", "partial", "failed"],
          "description": "Overall resolution outcome"
        }
      },
      "additionalProperties": true,
      "description": "Final remediation outputs"
    },
    "evidence_bundle_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA256 hash of bundle (excludes signatures and storage_locations)"
    },
    "signatures": {
      "type": "object",
      "description": "Cryptographic signatures (populated by signer)",
      "additionalProperties": true
    },
    "storage_locations": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Where bundle is stored (populated by uploader)"
    }
  }
}
