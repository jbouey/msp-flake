# GRUB A/B Partition Boot Configuration
#
# This configuration is sourced by the main grub.cfg to implement
# zero-touch A/B partition switching for OsirisCare appliances.
#
# Partition Layout:
#   /dev/sda1 (gpt1) - 512MB ESP (FAT32) - Contains this file and ab_state
#   /dev/sda2 (gpt2) - 2GB Partition A (squashfs)
#   /dev/sda3 (gpt3) - 2GB Partition B (squashfs)
#   /dev/sda4 (gpt4) - Remaining space Data (ext4) - /var/lib/msp
#
# Update Flow:
#   1. Update agent writes new ISO to standby partition
#   2. Update agent writes: set active_partition="B" to ab_state
#   3. System reboots, GRUB reads ab_state
#   4. GRUB boots from partition B
#   5. Health gate verifies system health
#   6. If healthy: ab_state remains B
#   7. If unhealthy after 3 boots: health gate writes A, reboots

# Default to partition A if ab_state doesn't exist
set active_partition="A"

# Try to read ab_state from ESP
# This file is written by update_agent.py and health_gate.py
set ab_state_file="(hd0,gpt1)/ab_state"
if [ -f $ab_state_file ]; then
    source $ab_state_file
fi

# Set boot parameters based on active partition
if [ "$active_partition" = "B" ]; then
    # Boot from Partition B
    set root='(hd0,gpt3)'
    set kernel_params="ab.partition=B quiet loglevel=3"
    echo "Booting from Partition B..."
else
    # Boot from Partition A (default)
    set root='(hd0,gpt2)'
    set kernel_params="ab.partition=A quiet loglevel=3"
    echo "Booting from Partition A..."
fi

# Boot menu entries
menuentry "OsirisCare Appliance" {
    # Root is already set above
    linux /boot/kernel $kernel_params
    initrd /boot/initrd
}

menuentry "OsirisCare Appliance (Partition A - Recovery)" {
    set root='(hd0,gpt2)'
    linux /boot/kernel ab.partition=A quiet loglevel=3
    initrd /boot/initrd
}

menuentry "OsirisCare Appliance (Partition B - Recovery)" {
    set root='(hd0,gpt3)'
    linux /boot/kernel ab.partition=B quiet loglevel=3
    initrd /boot/initrd
}

# Set timeout and default
set timeout=3
set default=0
