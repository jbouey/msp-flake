{
  "dashboard": {
    "title": "MSP HIPAA Compliance Dashboard",
    "tags": ["compliance", "hipaa", "msp"],
    "timezone": "utc",
    "schemaVersion": 38,
    "version": 1,
    "refresh": "30s",
    "editable": true,

    "panels": [
      {
        "id": 1,
        "title": "Compliance Score",
        "type": "stat",
        "gridPos": {"x": 0, "y": 0, "w": 6, "h": 4},
        "targets": [{
          "expr": "(count(msp_control_status{status=\"pass\"}) / count(msp_control_status)) * 100",
          "refId": "A",
          "legendFormat": "Compliance %"
        }],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 90, "color": "yellow"},
                {"value": 95, "color": "green"}
              ]
            },
            "mappings": [],
            "color": {"mode": "thresholds"}
          }
        },
        "options": {
          "graphMode": "area",
          "textMode": "value_and_name",
          "colorMode": "background"
        }
      },

      {
        "id": 2,
        "title": "Incidents (24h)",
        "type": "stat",
        "gridPos": {"x": 6, "y": 0, "w": 6, "h": 4},
        "targets": [{
          "expr": "count(increase(msp_incidents_total[24h]))",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 5, "color": "yellow"},
                {"value": 10, "color": "red"}
              ]
            }
          }
        },
        "options": {
          "graphMode": "area",
          "textMode": "value_and_name"
        }
      },

      {
        "id": 3,
        "title": "Auto-Fixes (24h)",
        "type": "stat",
        "gridPos": {"x": 12, "y": 0, "w": 6, "h": 4},
        "targets": [{
          "expr": "count(increase(msp_remediations_total{status=\"success\"}[24h]))",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"}
              ]
            },
            "color": {"mode": "palette-classic"}
          }
        },
        "options": {
          "graphMode": "area",
          "textMode": "value_and_name"
        }
      },

      {
        "id": 4,
        "title": "MTTR (Avg)",
        "type": "stat",
        "gridPos": {"x": 18, "y": 0, "w": 6, "h": 4},
        "targets": [{
          "expr": "avg(msp_remediation_duration_seconds) / 60",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "unit": "m",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 5, "color": "yellow"},
                {"value": 10, "color": "red"}
              ]
            },
            "decimals": 1
          }
        },
        "options": {
          "graphMode": "none",
          "textMode": "value_and_name"
        }
      },

      {
        "id": 5,
        "title": "8 Core Controls Status",
        "type": "table",
        "gridPos": {"x": 0, "y": 4, "w": 12, "h": 10},
        "targets": [{
          "expr": "msp_control_status",
          "refId": "A",
          "format": "table",
          "instant": true
        }],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true,
                "__name__": true,
                "instance": true,
                "job": true
              },
              "indexByName": {
                "control_id": 0,
                "control_name": 1,
                "status": 2,
                "last_check": 3,
                "evidence_count": 4
              },
              "renameByName": {
                "control_id": "Control ID",
                "control_name": "Control",
                "status": "Status",
                "last_check": "Last Check",
                "evidence_count": "Evidence"
              }
            }
          }
        ],
        "fieldConfig": {
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Status"},
              "properties": [{
                "id": "custom.displayMode",
                "value": "color-background"
              }, {
                "id": "mappings",
                "value": [
                  {"value": "pass", "text": "✅ Pass", "color": "green"},
                  {"value": "warn", "text": "⚠️ Warning", "color": "yellow"},
                  {"value": "fail", "text": "❌ Fail", "color": "red"}
                ]
              }]
            }
          ]
        },
        "options": {
          "showHeader": true,
          "cellHeight": "sm",
          "footer": {"show": false}
        }
      },

      {
        "id": 6,
        "title": "Incident Timeline (24h)",
        "type": "timeseries",
        "gridPos": {"x": 12, "y": 4, "w": 12, "h": 10},
        "targets": [{
          "expr": "rate(msp_incidents_total[5m])",
          "refId": "A",
          "legendFormat": "{{incident_type}}"
        }],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "custom": {
              "drawStyle": "bars",
              "lineInterpolation": "linear",
              "barAlignment": 0,
              "fillOpacity": 80,
              "gradientMode": "none",
              "pointSize": 5,
              "showPoints": "never",
              "spanNulls": false,
              "stacking": {"mode": "normal", "group": "A"},
              "axisPlacement": "auto",
              "axisLabel": "Incidents/sec",
              "scaleDistribution": {"type": "linear"}
            }
          }
        },
        "options": {
          "tooltip": {"mode": "multi"},
          "legend": {"displayMode": "list", "placement": "bottom"}
        }
      },

      {
        "id": 7,
        "title": "Recent Incidents",
        "type": "logs",
        "gridPos": {"x": 0, "y": 14, "w": 24, "h": 8},
        "targets": [{
          "expr": "{job=\"msp-incidents\"}",
          "refId": "A"
        }],
        "options": {
          "showTime": true,
          "showLabels": true,
          "showCommonLabels": false,
          "wrapLogMessage": false,
          "prettifyLogMessage": false,
          "enableLogDetails": true,
          "dedupStrategy": "none",
          "sortOrder": "Descending"
        }
      },

      {
        "id": 8,
        "title": "Evidence Bundles",
        "type": "table",
        "gridPos": {"x": 0, "y": 22, "w": 12, "h": 8},
        "targets": [{
          "expr": "msp_evidence_bundles",
          "refId": "A",
          "format": "table",
          "instant": true
        }],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true,
                "__name__": true
              },
              "indexByName": {
                "bundle_id": 0,
                "generated_at": 1,
                "signed": 2,
                "worm_url": 3
              },
              "renameByName": {
                "bundle_id": "Bundle ID",
                "generated_at": "Generated",
                "signed": "Signed",
                "worm_url": "Download"
              }
            }
          }
        ],
        "fieldConfig": {
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Download"},
              "properties": [{
                "id": "links",
                "value": [{
                  "title": "Download Bundle",
                  "url": "${__data.fields.worm_url}"
                }]
              }]
            },
            {
              "matcher": {"id": "byName", "options": "Signed"},
              "properties": [{
                "id": "custom.displayMode",
                "value": "color-background"
              }, {
                "id": "mappings",
                "value": [
                  {"value": "true", "text": "✅", "color": "green"},
                  {"value": "false", "text": "❌", "color": "red"}
                ]
              }]
            }
          ]
        },
        "options": {
          "showHeader": true
        }
      },

      {
        "id": 9,
        "title": "Remediation Success Rate",
        "type": "gauge",
        "gridPos": {"x": 12, "y": 22, "w": 6, "h": 8},
        "targets": [{
          "expr": "(sum(rate(msp_remediations_total{status=\"success\"}[24h])) / sum(rate(msp_remediations_total[24h]))) * 100",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 90, "color": "yellow"},
                {"value": 95, "color": "green"}
              ]
            }
          }
        },
        "options": {
          "showThresholdLabels": true,
          "showThresholdMarkers": true
        }
      },

      {
        "id": 10,
        "title": "System Health",
        "type": "stat",
        "gridPos": {"x": 18, "y": 22, "w": 6, "h": 8},
        "targets": [
          {
            "expr": "up{job=\"msp-server\"}",
            "refId": "A",
            "legendFormat": "MCP Server"
          },
          {
            "expr": "up{job=\"msp-monitoring\"}",
            "refId": "B",
            "legendFormat": "Monitoring"
          },
          {
            "expr": "up{job=\"msp-evidence\"}",
            "refId": "C",
            "legendFormat": "Evidence Pipeline"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 1, "color": "green"}
              ]
            },
            "mappings": [
              {"value": 0, "text": "Down"},
              {"value": 1, "text": "Up"}
            ]
          }
        },
        "options": {
          "textMode": "name",
          "colorMode": "background",
          "graphMode": "none"
        }
      }
    ],

    "templating": {
      "list": [
        {
          "name": "client",
          "type": "query",
          "datasource": "Prometheus",
          "query": "label_values(msp_control_status, client_id)",
          "current": {
            "text": "demo-clinic",
            "value": "demo-clinic"
          },
          "hide": 0,
          "includeAll": false,
          "multi": false,
          "refresh": 1
        }
      ]
    },

    "annotations": {
      "list": [
        {
          "name": "Incidents",
          "datasource": "Prometheus",
          "enable": true,
          "expr": "ALERTS{alertstate=\"firing\", severity=\"critical\"}",
          "iconColor": "red",
          "tagKeys": "alertname,severity",
          "textFormat": "{{alertname}}: {{description}}",
          "titleFormat": "Incident"
        },
        {
          "name": "Remediations",
          "datasource": "Prometheus",
          "enable": true,
          "expr": "changes(msp_remediations_total[1m]) > 0",
          "iconColor": "green",
          "textFormat": "Auto-fix completed",
          "titleFormat": "Remediation"
        }
      ]
    },

    "time": {
      "from": "now-24h",
      "to": "now"
    },

    "timepicker": {
      "refresh_intervals": ["10s", "30s", "1m", "5m", "15m", "30m", "1h"],
      "time_options": ["5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d"]
    }
  }
}
