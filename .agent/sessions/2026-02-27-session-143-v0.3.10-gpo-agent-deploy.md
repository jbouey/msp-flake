# Session 143: v0.3.10 GPO Agent Self-Deploy from NETLOGON

**Date:** 2026-02-27
**Duration:** ~3 hours (continued from session that ran out of context)

## Summary

Fixed the root cause of v0.3.4 persisting through rebuilds (wrong Nix file), confirmed v0.3.9 on both appliances, then built v0.3.10 with GPO-based agent self-deployment to bypass WinRM auth issues with workstations.

## Key Accomplishments

1. **Root cause: wrong Nix file** — `flake.nix` references `appliance-disk-image.nix` (not `appliance-image.nix`) for the `osiriscare-appliance-disk` config. Previous sessions updated the wrong file. `appliance-disk-image.nix` was stuck at v0.3.4.

2. **v0.3.9 confirmed on both appliances** — After fixing the Nix file and deploying via fleet order:
   - VM: running from `/nix/store/4hb4kskd15zmhbc6yx7ggd572fh227jc-appliance-daemon-0.3.9/bin/appliance-daemon`
   - Physical: v0.3.9 with WinRM HTTP fallback working (`DC 192.168.88.250: WinRM HTTPS unavailable, using HTTP (5985)`)

3. **WinRM auth investigation** — ws01 only offers Negotiate/Kerberos (no NTLM). DC works via NTLM but double-hop fails (Access is Denied). Direct WinRM to workstations is a dead end.

4. **GPO self-deployment (v0.3.10)** — New approach bypasses WinRM:
   - `autodeploy.go` stages `osiris-agent.exe` AND `osiris-config.json` to NETLOGON share
   - GPO startup script v2 copies agent+config from `\\NETLOGON\` to `C:\OsirisCare\`
   - Installs as Windows service on boot
   - Version-stamped to auto-update on GPO refresh

5. **Fleet order deployed** — Order `50311a01` active on VPS for nixos-rebuild to v0.3.10

## Commits

- `1248601` — fix: bump daemon version to 0.3.9 in appliance-disk-image.nix
- `c73c478` — feat: GPO startup script deploys agent from NETLOGON + config staging (v0.3.10)

## Next Priorities (when back on home WiFi)

1. Verify v0.3.10 deployed to both appliances
2. Verify GPO startup script updated on DC with agent deployment logic
3. Reboot ws01 (`VBoxManage controlvm northvalley-ws01 reset`) to trigger agent self-deploy
4. Verify osiris-agent installed and running on ws01
5. Verify gRPC TLS enrollment: agent → appliance :50051 → register → mTLS certs
6. End-to-end push/pull validation
