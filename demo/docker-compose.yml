# =============================================================================
# MSP COMPLIANCE PLATFORM - DEMO STACK
# =============================================================================
#
#  ██████╗ ███████╗██╗   ██╗     ██████╗ ███╗   ██╗██╗  ██╗   ██╗
#  ██╔══██╗██╔════╝██║   ██║    ██╔═══██╗████╗  ██║██║  ╚██╗ ██╔╝
#  ██║  ██║█████╗  ██║   ██║    ██║   ██║██╔██╗ ██║██║   ╚████╔╝
#  ██║  ██║██╔══╝  ╚██╗ ██╔╝    ██║   ██║██║╚██╗██║██║    ╚██╔╝
#  ██████╔╝███████╗ ╚████╔╝     ╚██████╔╝██║ ╚████║███████╗██║
#  ╚═════╝ ╚══════╝  ╚═══╝       ╚═════╝ ╚═╝  ╚═══╝╚══════╝╚═╝
#
#  THIS IS FOR LOCAL DEVELOPMENT AND TESTING ONLY
#  DO NOT USE IN PRODUCTION - NO SECURITY HARDENING
#
# =============================================================================
#
# Usage:
#   docker compose up -d        # Start all services
#   docker compose logs -f      # Follow logs
#   docker compose down -v      # Stop and remove volumes
#
# Services:
#   - mcp-server:  FastAPI MCP server (port 8001)
#   - redis:       Event queue and caching (port 6379)
#   - minio:       S3-compatible WORM storage (port 9000, console 9001)
#   - agent:       Compliance agent in demo mode
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Redis - Event Queue
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: msp-demo-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - msp-demo

  # ---------------------------------------------------------------------------
  # MinIO - S3-Compatible WORM Storage (Evidence Bundles)
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: msp-demo-minio
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - msp-demo

  # ---------------------------------------------------------------------------
  # MinIO Bootstrap - Create buckets on startup
  # ---------------------------------------------------------------------------
  minio-init:
    image: minio/mc:latest
    container_name: msp-demo-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin123;
      mc mb --ignore-existing myminio/evidence;
      mc mb --ignore-existing myminio/compliance-packets;
      mc anonymous set download myminio/compliance-packets;
      echo 'Buckets created successfully';
      exit 0;
      "
    networks:
      - msp-demo

  # ---------------------------------------------------------------------------
  # MCP Server - FastAPI with stub endpoints
  # ---------------------------------------------------------------------------
  mcp-server:
    build:
      context: ./mcp-stub
      dockerfile: Dockerfile
    container_name: msp-demo-mcp
    ports:
      - "8001:8001"
    environment:
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin123
      - LOG_LEVEL=DEBUG
    depends_on:
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - msp-demo

  # ---------------------------------------------------------------------------
  # Compliance Agent - Demo mode (polls MCP, generates evidence)
  # ---------------------------------------------------------------------------
  agent:
    build:
      context: ./agent-stub
      dockerfile: Dockerfile
    container_name: msp-demo-agent
    environment:
      - MCP_URL=http://mcp-server:8001
      - SITE_ID=demo-site-001
      - HOST_ID=demo-host-001
      - POLL_INTERVAL=30
      - LOG_LEVEL=DEBUG
      - DEMO_MODE=true
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - msp-demo

# =============================================================================
# Networks
# =============================================================================
networks:
  msp-demo:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis-data:
  minio-data:
