id: RB-DRIFT-001
name: "Configuration Drift Remediation"
description: "Detect and fix configuration drift from approved baseline"
hipaa_controls:
  - "164.308(a)(1)(ii)(D)"  # Information System Activity Review
  - "164.310(d)(1)"  # Device and Media Controls
severity: medium
category: configuration_management

steps:
  - id: 1
    action: check_current_configuration
    description: "Get current NixOS generation hash"
    timeout: 10
    command: "readlink /run/current-system"
    parse_output: true

  - id: 2
    action: compare_with_baseline
    description: "Compare against approved baseline"
    timeout: 10
    command: "nix-store --query --hash /run/current-system"
    expected_hash: "${BASELINE_HASH}"

  - id: 3
    action: identify_drift
    description: "List configuration differences"
    timeout: 30
    command: "nix-store --query --tree /run/current-system | diff - ${BASELINE_DERIVATION}"
    capture_output: true

  - id: 4
    action: backup_current_generation
    description: "Backup current generation before rollback"
    timeout: 10
    command: "nix-env --list-generations --profile /nix/var/nix/profiles/system"
    capture_output: true

  - id: 5
    action: rollback_to_baseline
    description: "Switch to approved baseline configuration"
    timeout: 120
    command: "nixos-rebuild switch --flake ${BASELINE_FLAKE_URL}"
    verify_completion: true

  - id: 6
    action: verify_baseline_active
    description: "Confirm baseline is now active"
    timeout: 10
    command: "nix-store --query --hash /run/current-system"
    success_condition: "hash == ${BASELINE_HASH}"

rollback:
  - action: revert_to_previous_generation
    command: "nixos-rebuild switch --rollback"
  - action: alert_administrator
    command: "echo 'Drift remediation failed' | mail -s 'WARNING: Configuration Drift' admin@clinic.local"

evidence_required:
  - original_generation
  - baseline_generation
  - drift_diff
  - rollback_timestamp
  - verification_hash

output_format:
  type: "json"
  schema:
    incident_id: "string"
    runbook_id: "string"
    drift_detected: "boolean"
    baseline_restored: "boolean"
    outcome: "success|failure"
