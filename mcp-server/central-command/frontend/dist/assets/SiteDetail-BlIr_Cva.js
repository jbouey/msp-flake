import{x as A,y as G,r as u,j as e,G as h,S as C,B as v,s as V,m as q,z as K,A as J,C as Q,D as Z,E as X,F as Y,J as ee,K as k,M as se}from"./index-DEFEL2Dr.js";const te=5e3,ae=2e3;function le(s){return A({queryKey:["deployment",s],queryFn:()=>G.getStatus(s),enabled:!!s,refetchInterval:t=>{var l;const o=(l=t.state.data)==null?void 0:l.phase;return o&&o!=="complete"?te:!1},staleTime:ae})}const re=({actions:s,label:t="More",icon:o,disabled:l=!1,className:r=""})=>{const[n,x]=u.useState(!1),d=u.useRef(null);return u.useEffect(()=>{const c=p=>{d.current&&!d.current.contains(p.target)&&x(!1)};return n&&document.addEventListener("mousedown",c),()=>{document.removeEventListener("mousedown",c)}},[n]),u.useEffect(()=>{const c=p=>{p.key==="Escape"&&x(!1)};return n&&document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[n]),e.jsxs("div",{ref:d,className:`relative inline-block ${r}`,children:[e.jsxs("button",{onClick:()=>x(!n),disabled:l,className:`
          flex items-center gap-1 px-2 py-1 text-sm rounded-ios
          bg-fill-secondary hover:bg-fill-tertiary
          text-label-secondary
          disabled:opacity-50 disabled:cursor-not-allowed
          transition-colors
        `,children:[o||e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"})}),t&&e.jsx("span",{children:t})]}),n&&e.jsx("div",{className:"absolute right-0 mt-1 w-48 bg-fill-primary rounded-ios shadow-lg border border-separator-light z-[9999]",children:e.jsx("div",{className:"py-1",children:s.map((c,p)=>e.jsxs("button",{onClick:()=>{c.disabled||(c.onClick(),x(!1))},disabled:c.disabled,className:`
                  w-full flex items-center gap-2 px-3 py-2 text-sm text-left
                  ${c.danger?"text-white bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 font-medium":"text-label-primary hover:bg-fill-secondary"}
                  disabled:opacity-50 disabled:cursor-not-allowed
                  transition-colors
                `,children:[c.icon,c.label]},p))})})]})},ie=({siteId:s})=>{const{data:t,isLoading:o,error:l}=le(s);if(o)return e.jsx(h,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(C,{}),e.jsx("span",{className:"text-label-secondary",children:"Loading deployment status..."})]})});if(l)return e.jsx(h,{className:"p-6",children:e.jsxs("div",{className:"text-health-critical",children:["Failed to load deployment status: ",l instanceof Error?l.message:"Unknown error"]})});if(!t)return e.jsx(h,{className:"p-6",children:e.jsx("div",{className:"text-label-secondary",children:"No deployment in progress"})});const r=[{key:"discovering",label:"Discovering Domain",icon:"ðŸ”",description:"Detecting AD domain via DNS"},{key:"awaiting_credentials",label:"Awaiting Credentials",icon:"ðŸ”",description:"Enter domain admin credentials"},{key:"enumerating",label:"Enumerating AD",icon:"ðŸ“‹",description:"Discovering servers and workstations"},{key:"deploying",label:"Deploying Agents",icon:"ðŸš€",description:"Installing Go agents on workstations"},{key:"scanning",label:"First Scan",icon:"âœ…",description:"Running initial compliance scan"},{key:"complete",label:"Complete",icon:"ðŸŽ‰",description:"Deployment finished"}],n=r.findIndex(d=>d.key===t.phase),x=t.phase==="complete"?100:(n+1)/r.length*100;return e.jsxs(h,{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-label-primary mb-2",children:"Deployment Progress"}),e.jsx("p",{className:"text-sm text-label-secondary",children:"Zero-friction deployment pipeline status"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"h-2 bg-separator-light/50 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500",style:{width:`${x}%`}})}),e.jsxs("div",{className:"mt-2 text-sm text-label-secondary text-right",children:[x.toFixed(0),"% complete"]})]}),e.jsx("div",{className:"space-y-4",children:r.map((d,c)=>{var j,a,f,N;const p=c<n,b=c===n;return e.jsxs("div",{className:`flex items-start gap-4 p-3 rounded-lg transition-all ${b?"bg-blue-500/20 border border-blue-500/50":p?"bg-health-healthy/10":"bg-separator-light/20"}`,children:[e.jsx("div",{className:`text-2xl flex-shrink-0 ${p?"opacity-100":b?"opacity-100 animate-pulse":"opacity-40"}`,children:d.icon}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:`font-medium ${b?"text-blue-400":p?"text-health-healthy":"text-label-tertiary"}`,children:d.label}),b&&e.jsx(v,{className:"bg-blue-500 text-white text-xs",children:"In Progress"}),p&&e.jsx(v,{className:"bg-health-healthy text-white text-xs",children:"âœ“ Complete"})]}),e.jsx("p",{className:"text-sm text-label-secondary",children:d.description}),b&&d.key==="awaiting_credentials"&&((j=t.details)==null?void 0:j.domain_discovered)&&e.jsxs("div",{className:"mt-3 p-3 bg-blue-500/10 rounded border border-blue-500/30",children:[e.jsxs("p",{className:"text-sm text-label-primary mb-2",children:[e.jsx("strong",{children:"Domain Discovered:"})," ",t.details.domain_discovered]}),e.jsx("a",{href:`/sites/${s}/credentials`,className:"inline-block px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors",children:"Enter Domain Credentials â†’"})]}),b&&d.key==="enumerating"&&e.jsx("div",{className:"mt-2 text-sm text-label-secondary",children:((a=t.details)==null?void 0:a.servers_found)!==void 0&&e.jsxs("span",{children:["Found ",t.details.servers_found," servers, ",t.details.workstations_found," workstations"]})}),b&&d.key==="deploying"&&e.jsx("div",{className:"mt-2 text-sm text-label-secondary",children:((f=t.details)==null?void 0:f.agents_deployed)!==void 0&&e.jsxs("span",{children:["Deployed to ",t.details.agents_deployed," workstations"]})}),b&&d.key==="scanning"&&((N=t.details)==null?void 0:N.first_scan_complete)&&e.jsx("div",{className:"mt-2 text-sm text-health-healthy",children:"âœ“ First compliance report generated"})]})]},d.key)})}),t.details&&(t.details.servers_found!==void 0||t.details.workstations_found!==void 0)&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-separator-light",children:[e.jsx("h4",{className:"text-sm font-semibold text-label-primary mb-3",children:"Discovery Summary"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.details.servers_found!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-label-primary",children:t.details.servers_found}),e.jsx("div",{className:"text-xs text-label-secondary",children:"Servers"})]}),t.details.workstations_found!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-label-primary",children:t.details.workstations_found}),e.jsx("div",{className:"text-xs text-label-secondary",children:"Workstations"})]}),t.details.agents_deployed!==void 0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-label-primary",children:t.details.agents_deployed}),e.jsx("div",{className:"text-xs text-label-secondary",children:"Agents Deployed"})]})]})]})]})};function _(s){if(!s)return"Never";const t=new Date(s),l=new Date().getTime()-t.getTime(),r=Math.floor(l/6e4);if(r<1)return"Just now";if(r<60)return`${r} min ago`;const n=Math.floor(r/60);return n<24?`${n}h ago`:`${Math.floor(n/24)}d ago`}function ne(s){if(!s)return"Unknown";const t=Math.floor(s/86400),o=Math.floor(s%86400/3600),l=Math.floor(s%3600/60);return t>0?`${t}d ${o}h`:o>0?`${o}h ${l}m`:`${l}m`}const T="https://api.osiriscare.net/agent-packages",oe=({appliance:s,latestVersion:t,onCreateOrder:o,onDelete:l,isLoading:r})=>{const[n,x]=u.useState(!1),[d,c]=u.useState(!1),p=t&&s.agent_version&&s.agent_version!==t,b={online:"bg-health-healthy",stale:"bg-health-warning",offline:"bg-health-critical",pending:"bg-gray-400"},j=[{label:"View Logs",icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),onClick:()=>o(s.appliance_id,"view_logs")},{label:"Restart Agent",icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),onClick:()=>o(s.appliance_id,"restart_agent")},{label:"Update Agent",icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),onClick:()=>c(!0)},{label:"Delete Appliance",icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),onClick:()=>x(!0),danger:!0}];return e.jsxs(h,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${b[s.live_status]}`}),e.jsx("h3",{className:"font-semibold text-label-primary",children:s.hostname||s.appliance_id})]}),e.jsx(v,{variant:s.live_status==="online"?"success":"default",children:s.live_status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"MAC Address"}),e.jsx("p",{className:"text-label-secondary font-mono",children:s.mac_address||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"IP Addresses"}),e.jsx("p",{className:"text-label-secondary font-mono",children:s.ip_addresses.length>0?s.ip_addresses.join(", "):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"Agent Version"}),e.jsx("p",{className:"text-label-secondary",children:s.agent_version||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"NixOS Version"}),e.jsx("p",{className:"text-label-secondary",children:s.nixos_version||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"Last Checkin"}),e.jsx("p",{className:"text-label-secondary",children:_(s.last_checkin)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"Uptime"}),e.jsx("p",{className:"text-label-secondary",children:ne(s.uptime_seconds)})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-separator-light flex items-center justify-between",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>o(s.appliance_id,"force_checkin"),disabled:r,className:"px-3 py-1.5 text-xs rounded-ios bg-accent-primary/10 text-accent-primary hover:bg-accent-primary/20 disabled:opacity-50 transition-colors",children:"Force Checkin"}),e.jsx("button",{onClick:()=>o(s.appliance_id,"run_drift"),disabled:r,className:"px-3 py-1.5 text-xs rounded-ios bg-fill-secondary text-label-primary hover:bg-fill-tertiary disabled:opacity-50 transition-colors",children:"Run Drift"}),e.jsx("button",{onClick:()=>o(s.appliance_id,"sync_rules"),disabled:r,className:"px-3 py-1.5 text-xs rounded-ios bg-fill-secondary text-label-primary hover:bg-fill-tertiary disabled:opacity-50 transition-colors",children:"Sync Rules"}),p&&e.jsxs("button",{onClick:()=>c(!0),disabled:r,className:"px-3 py-1.5 text-xs rounded-ios bg-gradient-to-r from-blue-600 to-purple-500 hover:from-blue-700 hover:to-purple-600 text-white font-medium disabled:opacity-50 transition-all shadow-sm animate-pulse",children:["Push Update (",s.agent_version," â†’ ",t,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.live_status==="offline"&&e.jsx("button",{onClick:()=>x(!0),disabled:r,className:"px-3 py-1.5 text-xs rounded-ios bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white font-medium disabled:opacity-50 transition-all shadow-sm",children:"ðŸ—‘ï¸ Delete Stale"}),e.jsx(re,{actions:j,label:"",disabled:r})]})]}),n&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(h,{className:"w-full max-w-sm",children:[e.jsx("h2",{className:"text-lg font-semibold text-label-primary mb-2",children:"Delete Appliance?"}),e.jsxs("p",{className:"text-label-secondary text-sm mb-4",children:["Are you sure you want to delete ",e.jsx("strong",{children:s.hostname||s.appliance_id}),"? This will remove it from the site and cancel any pending orders."]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>x(!1),className:"flex-1 px-4 py-2 rounded-ios bg-fill-secondary text-label-primary",children:"Cancel"}),e.jsx("button",{onClick:()=>{l(s.appliance_id),x(!1)},className:"flex-1 px-4 py-2 rounded-ios bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white font-semibold shadow-md transition-all",children:"Delete Forever"})]})]})}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(h,{className:"w-full max-w-md",children:[e.jsx("h2",{className:"text-lg font-semibold text-label-primary mb-2",children:"Push Agent Update"}),e.jsxs("p",{className:"text-label-secondary text-sm mb-4",children:["Update ",e.jsx("strong",{children:s.hostname||s.appliance_id})," from version"," ",e.jsx("code",{className:"bg-fill-secondary px-1 rounded",children:s.agent_version||"unknown"})," to"," ",e.jsx("code",{className:"bg-fill-secondary px-1 rounded",children:t})]}),e.jsxs("div",{className:"bg-fill-secondary rounded-ios p-3 mb-4 text-sm",children:[e.jsx("p",{className:"text-label-tertiary mb-1",children:"Package URL:"}),e.jsxs("p",{className:"text-label-primary font-mono text-xs break-all",children:[T,"/compliance_agent-",t,".tar.gz"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>c(!1),className:"flex-1 px-4 py-2 rounded-ios bg-fill-secondary text-label-primary",children:"Cancel"}),e.jsx("button",{onClick:()=>{o(s.appliance_id,"update_agent",{package_url:`${T}/compliance_agent-${t}.tar.gz`,version:t}),c(!1)},disabled:r,className:"flex-1 px-4 py-2 rounded-ios bg-gradient-to-r from-blue-600 to-purple-500 hover:from-blue-700 hover:to-purple-600 text-white font-semibold shadow-md transition-all disabled:opacity-50",children:"Push Update"})]})]})})]})},ce=({timestamps:s,stage:t})=>{const o=[{key:"lead_at",label:"Lead",icon:"ðŸ‘¤"},{key:"discovery_at",label:"Discovery",icon:"ðŸ”"},{key:"proposal_at",label:"Proposal",icon:"ðŸ“‹"},{key:"contract_at",label:"Contract",icon:"âœï¸"},{key:"intake_at",label:"Intake",icon:"ðŸ“"},{key:"creds_at",label:"Credentials",icon:"ðŸ”‘"},{key:"shipped_at",label:"Shipped",icon:"ðŸ“¦"},{key:"received_at",label:"Received",icon:"ðŸ“¬"},{key:"connectivity_at",label:"Connected",icon:"ðŸ”Œ"},{key:"scanning_at",label:"Scanning",icon:"ðŸ”¬"},{key:"baseline_at",label:"Baseline",icon:"ðŸ“Š"},{key:"active_at",label:"Active",icon:"âœ…"}];return e.jsx("div",{className:"space-y-2",children:o.map(l=>{const r=s[l.key]!==null,n=t===l.key.replace("_at","");return e.jsxs("div",{className:`flex items-center gap-3 py-2 px-3 rounded-ios transition-colors ${n?"bg-accent-primary/10":r?"bg-fill-secondary":""}`,children:[e.jsx("span",{className:"text-lg",children:r?"âœ…":l.icon}),e.jsx("span",{className:`flex-1 ${r?"text-label-primary":"text-label-tertiary"}`,children:l.label}),s[l.key]&&e.jsx("span",{className:"text-xs text-label-tertiary",children:new Date(s[l.key]).toLocaleDateString()})]},l.key)})})},de=({isOpen:s,onClose:t,onSubmit:o,isLoading:l})=>{const[r,n]=u.useState("router"),[x,d]=u.useState(""),[c,p]=u.useState(""),[b,j]=u.useState(""),[a,f]=u.useState("");if(!s)return null;const N=y=>{y.preventDefault(),o({credential_type:r,credential_name:x,username:c||void 0,password:b||void 0,host:a||void 0}),d(""),p(""),j(""),f("")};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(h,{className:"w-full max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Add Credential"}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-label-secondary mb-1",children:"Type"}),e.jsxs("select",{value:r,onChange:y=>n(y.target.value),className:"w-full px-3 py-2 rounded-ios bg-fill-secondary text-label-primary border border-separator-light",children:[e.jsx("option",{value:"router",children:"Router"}),e.jsx("option",{value:"active_directory",children:"Active Directory"}),e.jsx("option",{value:"ehr",children:"EHR System"}),e.jsx("option",{value:"backup",children:"Backup Service"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-label-secondary mb-1",children:"Name *"}),e.jsx("input",{type:"text",value:x,onChange:y=>d(y.target.value),placeholder:"e.g., Main Router, Domain Admin",className:"w-full px-3 py-2 rounded-ios bg-fill-secondary text-label-primary border border-separator-light",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-label-secondary mb-1",children:"Host/IP"}),e.jsx("input",{type:"text",value:a,onChange:y=>f(y.target.value),placeholder:"192.168.1.1",className:"w-full px-3 py-2 rounded-ios bg-fill-secondary text-label-primary border border-separator-light"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-label-secondary mb-1",children:"Username"}),e.jsx("input",{type:"text",value:c,onChange:y=>p(y.target.value),className:"w-full px-3 py-2 rounded-ios bg-fill-secondary text-label-primary border border-separator-light"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-label-secondary mb-1",children:"Password"}),e.jsx("input",{type:"password",value:b,onChange:y=>j(y.target.value),className:"w-full px-3 py-2 rounded-ios bg-fill-secondary text-label-primary border border-separator-light"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:t,className:"flex-1 px-4 py-2 rounded-ios bg-fill-secondary text-label-primary",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:!x||l,className:"flex-1 px-4 py-2 rounded-ios bg-accent-primary text-white disabled:opacity-50",children:l?"Adding...":"Add Credential"})]})]})]})})},xe=({applianceCount:s,onBroadcast:t,onClearStale:o,isLoading:l})=>{const[r,n]=u.useState(!1);return s===0?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"text-label-tertiary text-sm mr-2",children:"Site Actions:"}),e.jsx("button",{onClick:()=>t("force_checkin"),disabled:l,className:"px-3 py-1.5 text-xs rounded-ios bg-accent-primary text-white hover:bg-accent-primary/90 disabled:opacity-50 transition-colors",children:"Force All Checkin"}),e.jsx("button",{onClick:()=>t("sync_rules"),disabled:l,className:"px-3 py-1.5 text-xs rounded-ios bg-fill-secondary text-label-primary hover:bg-fill-tertiary disabled:opacity-50 transition-colors",children:"Sync All Rules"}),e.jsx("button",{onClick:()=>n(!0),disabled:l,className:"px-3 py-1.5 text-xs rounded-ios bg-health-warning/10 text-health-warning hover:bg-health-warning/20 disabled:opacity-50 transition-colors",children:"Clear Stale"})]}),r&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(h,{className:"w-full max-w-sm",children:[e.jsx("h2",{className:"text-lg font-semibold text-label-primary mb-2",children:"Clear Stale Appliances?"}),e.jsx("p",{className:"text-label-secondary text-sm mb-4",children:"This will remove all appliances that haven't checked in for more than 24 hours. This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>n(!1),className:"flex-1 px-4 py-2 rounded-ios bg-fill-secondary text-label-primary",children:"Cancel"}),e.jsx("button",{onClick:()=>{o(),n(!1)},className:"flex-1 px-4 py-2 rounded-ios bg-health-warning text-white",children:"Clear Stale"})]})]})})]})},me=({siteId:s})=>{const{data:t,isLoading:o}=A({queryKey:["evidence-signing-status",s],queryFn:async()=>{const n=localStorage.getItem("auth_token"),x=await fetch(`/api/evidence/sites/${s}/signing-status`,{headers:n?{Authorization:`Bearer ${n}`}:{}});return x.ok?x.json():null},staleTime:3e4,retry:!1});if(o||!t)return null;const l=t.status==="healthy"?"success":t.status==="broken"?"error":"default",r=t.status==="healthy"?"Active":t.status==="broken"?"Broken":"No Key";return e.jsxs(h,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Evidence Chain"}),e.jsx(v,{variant:l,children:r})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"Signing Key"}),e.jsx("p",{className:"text-label-primary font-mono text-xs",children:t.key_fingerprint||"Not registered"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"Verified Bundles"}),e.jsx("p",{className:"text-label-primary",children:t.verified_bundle_count})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary",children:"Last Accepted"}),e.jsx("p",{className:"text-label-primary",children:t.last_accepted?_(t.last_accepted):"Never"})]}),t.evidence_rejection_count>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary text-red-500",children:"Rejections"}),e.jsxs("p",{className:"text-red-500 font-semibold",children:[t.evidence_rejection_count," (",t.last_rejection?_(t.last_rejection):"",")"]})]})]})]})},pe=()=>{const{siteId:s}=V(),t=q(),[o,l]=u.useState(!1),[r,n]=u.useState(null),[x,d]=u.useState(!1),[c,p]=u.useState(null),[b,j]=u.useState(!1),{data:a,isLoading:f,error:N}=K(s||null),{data:y}=A({queryKey:["fleet-stats"],queryFn:se.getStats,staleTime:6e4}),E=(y==null?void 0:y.releases.latest_version)??null,S=J(),L=Q(),M=Z(),D=X(),$=Y(),w=ee(),P=L.isPending||M.isPending||D.isPending||$.isPending,g=(i,m)=>{n({message:i,type:m}),setTimeout(()=>n(null),3e3)},B=async()=>{if(s){j(!0);try{const i=await fetch(`/api/portal/sites/${s}/generate-token`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error("Failed to generate portal link");const m=await i.json();p({url:m.portal_url,token:m.token}),d(!0)}catch(i){g(`Failed to generate portal link: ${i}`,"error")}finally{j(!1)}}},F=async(i,m,I)=>{if(s)try{await L.mutateAsync({siteId:s,applianceId:i,orderType:m,parameters:I}),g(`Order "${m}" sent to appliance`,"success")}catch(W){g(`Failed to create order: ${W}`,"error")}},z=async i=>{if(s)try{const m=await M.mutateAsync({siteId:s,orderType:i});g(`Order "${i}" broadcast to ${m.length} appliances`,"success")}catch(m){g(`Failed to broadcast order: ${m}`,"error")}},H=async i=>{if(s)try{await D.mutateAsync({siteId:s,applianceId:i}),g("Appliance deleted","success")}catch(m){g(`Failed to delete appliance: ${m}`,"error")}},U=async()=>{if(s)try{const i=await $.mutateAsync({siteId:s,staleHours:24});g(`Cleared ${i.deleted_count} stale appliances`,"success")}catch(i){g(`Failed to clear stale appliances: ${i}`,"error")}},R=async i=>{if(s)try{await w.mutateAsync({siteId:s,healingTier:i}),g(`Healing tier updated to ${i==="full_coverage"?"Full Coverage (21 rules)":"Standard (4 rules)"}`,"success")}catch(m){g(`Failed to update healing tier: ${m}`,"error")}};if(f)return e.jsx("div",{className:"flex items-center justify-center py-24",children:e.jsx(C,{size:"lg"})});if(N||!a)return e.jsxs(h,{className:"text-center py-12",children:[e.jsx("h2",{className:"text-xl font-semibold text-label-primary mb-2",children:"Site Not Found"}),e.jsxs("p",{className:"text-label-tertiary mb-4",children:['The site "',s,'" could not be found.']}),e.jsx("button",{onClick:()=>t("/sites"),className:"btn-primary",children:"Back to Sites"})]});const O=async i=>{try{await S.mutateAsync({siteId:a.site_id,data:i}),l(!1)}catch(m){console.error("Failed to add credential:",m)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("button",{onClick:()=>t("/sites"),className:"p-2 mt-1 rounded-ios-sm hover:bg-fill-secondary transition-colors",children:e.jsx("svg",{className:"w-5 h-5 text-label-secondary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-semibold text-label-primary truncate",children:a.clinic_name}),e.jsx(v,{variant:a.live_status==="online"?"success":a.live_status==="offline"?"error":"default",children:a.live_status})]}),e.jsx("p",{className:"text-label-tertiary text-sm mt-0.5",children:a.site_id})]}),e.jsxs("button",{onClick:B,disabled:b,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm text-accent-primary hover:bg-accent-tint rounded-ios-sm transition-colors disabled:opacity-50 whitespace-nowrap",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})}),b?"Generating...":"Portal Link"]})]}),e.jsxs("nav",{className:"flex items-center gap-1.5 mt-4 pt-3 border-t border-separator-light overflow-x-auto",children:[e.jsxs(k,{to:`/sites/${s}/devices`,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-ios-sm bg-separator-light text-label-primary hover:bg-separator-medium transition-colors whitespace-nowrap",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"})}),"Devices"]}),e.jsxs(k,{to:`/sites/${s}/workstations`,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-ios-sm bg-separator-light text-label-primary hover:bg-separator-medium transition-colors whitespace-nowrap",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),"Workstations"]}),e.jsxs(k,{to:`/sites/${s}/agents`,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-ios-sm bg-separator-light text-label-primary hover:bg-separator-medium transition-colors whitespace-nowrap",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"})}),"Go Agents"]}),e.jsx("div",{className:"w-px h-5 bg-separator-medium mx-0.5 flex-shrink-0"}),e.jsxs(k,{to:`/sites/${s}/frameworks`,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-ios-sm bg-separator-light text-label-primary hover:bg-separator-medium transition-colors whitespace-nowrap",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"})}),"Frameworks"]}),e.jsxs(k,{to:`/sites/${s}/integrations`,className:"flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-ios-sm bg-separator-light text-label-primary hover:bg-separator-medium transition-colors whitespace-nowrap",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Cloud Integrations"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[s&&e.jsx(ie,{siteId:s}),e.jsxs(h,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Contact Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary text-sm",children:"Contact Name"}),e.jsx("p",{className:"text-label-primary",children:a.contact_name||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary text-sm",children:"Email"}),e.jsx("p",{className:"text-label-primary",children:a.contact_email||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary text-sm",children:"Phone"}),e.jsx("p",{className:"text-label-primary",children:a.contact_phone||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary text-sm",children:"Tier"}),e.jsx(v,{variant:a.tier==="large"?"success":a.tier==="mid"?"info":"default",children:a.tier})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-label-tertiary text-sm",children:"Healing Mode"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:a.healing_tier||"standard",onChange:i=>R(i.target.value),disabled:w.isPending,className:"px-2 py-1 text-sm rounded-ios bg-fill-secondary text-label-primary border border-separator-light focus:outline-none focus:ring-2 focus:ring-accent-primary disabled:opacity-50",children:[e.jsx("option",{value:"standard",children:"Standard (4 rules)"}),e.jsx("option",{value:"full_coverage",children:"Full Coverage (21 rules)"})]}),w.isPending&&e.jsx(C,{size:"sm"})]})]}),a.address&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-label-tertiary text-sm",children:"Address"}),e.jsx("p",{className:"text-label-primary",children:a.address})]})]})]}),e.jsxs(h,{className:"relative z-10",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4",children:["Appliances (",a.appliances.length,")"]}),e.jsx(xe,{applianceCount:a.appliances.length,onBroadcast:z,onClearStale:U,isLoading:P}),a.appliances.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-label-tertiary",children:"No appliances connected yet."}),e.jsx("p",{className:"text-label-tertiary text-sm mt-1",children:"The appliance will appear here when it phones home."})]}):e.jsx("div",{className:"space-y-4",children:a.appliances.map(i=>e.jsx(oe,{appliance:i,latestVersion:E,onCreateOrder:F,onDelete:H,isLoading:P},i.appliance_id))})]}),s&&e.jsx(me,{siteId:s}),e.jsxs(h,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold",children:["Credentials (",a.credentials.length,")"]}),e.jsx("button",{onClick:()=>l(!0),className:"text-sm text-accent-primary hover:text-accent-primary/80",children:"+ Add Credential"})]}),a.credentials.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-label-tertiary",children:"No credentials stored."}),e.jsx("p",{className:"text-label-tertiary text-sm mt-1",children:"Add router, AD, or other credentials for the appliance."})]}):e.jsx("div",{className:"space-y-2",children:a.credentials.map(i=>e.jsxs("div",{className:"flex items-center justify-between py-3 px-4 bg-fill-secondary rounded-ios",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-label-primary",children:i.credential_name}),e.jsx("p",{className:"text-xs text-label-tertiary",children:i.credential_type})]}),e.jsx(v,{variant:"default",children:"Stored"})]},i.id))})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(h,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Onboarding Progress"}),e.jsx(ce,{timestamps:a.timestamps,stage:a.onboarding_stage})]}),a.notes&&e.jsxs(h,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"Notes"}),e.jsx("p",{className:"text-label-secondary text-sm",children:a.notes})]}),a.blockers.length>0&&e.jsxs(h,{className:"border-l-4 border-health-warning",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"Blockers"}),e.jsx("ul",{className:"space-y-2",children:a.blockers.map((i,m)=>e.jsxs("li",{className:"text-sm text-label-secondary flex items-start gap-2",children:[e.jsx("span",{className:"text-health-warning",children:"!"}),i]},m))})]}),a.tracking_number&&e.jsxs(h,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"Shipping"}),e.jsx("p",{className:"text-label-tertiary text-sm",children:"Carrier"}),e.jsx("p",{className:"text-label-primary",children:a.tracking_carrier||"Unknown"}),e.jsx("p",{className:"text-label-tertiary text-sm mt-2",children:"Tracking Number"}),e.jsx("p",{className:"text-label-primary font-mono text-sm",children:a.tracking_number})]})]})]}),e.jsx(de,{isOpen:o,onClose:()=>l(!1),onSubmit:O,isLoading:S.isPending}),x&&c&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(h,{className:"w-full max-w-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-label-primary",children:"Client Portal Link"}),e.jsx("button",{onClick:()=>d(!1),className:"p-2 hover:bg-fill-secondary rounded-ios transition-colors",children:e.jsx("svg",{className:"w-5 h-5 text-label-tertiary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("p",{className:"text-label-secondary text-sm mb-4",children:"Share this link with your client to give them access to their compliance dashboard. The link does not expire."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-label-tertiary mb-1",children:"Portal URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:c.url,readOnly:!0,className:"flex-1 px-3 py-2 rounded-ios bg-fill-secondary text-label-primary border border-separator-light font-mono text-sm"}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(c.url),g("Portal URL copied to clipboard","success")},className:"px-4 py-2 rounded-ios bg-accent-primary text-white hover:bg-accent-primary/90 transition-colors",children:"Copy"})]})]}),e.jsx("div",{className:"pt-2 border-t border-separator-light",children:e.jsxs("p",{className:"text-xs text-label-tertiary",children:[e.jsx("strong",{children:"Security note:"})," This link provides read-only access to compliance reports and evidence. Generate a new link if you need to revoke access."]})})]}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsx("button",{onClick:()=>d(!1),className:"px-4 py-2 rounded-ios bg-fill-secondary text-label-primary hover:bg-fill-tertiary transition-colors",children:"Done"})})]})}),r&&e.jsx("div",{className:`fixed bottom-4 right-4 px-4 py-3 rounded-ios shadow-lg z-50 ${r.type==="success"?"bg-health-healthy text-white":"bg-health-critical text-white"}`,children:r.message})]})};export{pe as SiteDetail,pe as default};
