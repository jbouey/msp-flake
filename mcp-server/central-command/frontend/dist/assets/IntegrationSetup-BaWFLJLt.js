import{s as v,m as k,r as x,j as e,K as g}from"./index-ByrxzNCH.js";import{d as A,e as I,P as m,f as C}from"./useIntegrations-By3XSF4u.js";const R=["accounts.google.com","login.microsoftonline.com","login.live.com","login.windows.net","oauth.okta.com",".okta.com"];function S(s){try{const l=new URL(s);if(l.protocol!=="https:")return!1;const a=l.hostname.toLowerCase();return R.some(n=>n.startsWith(".")?a.endsWith(n)||a===n.slice(1):a===n)}catch{return!1}}function O({provider:s,selected:l,onSelect:a}){const n=m[s];return e.jsxs("button",{onClick:a,className:`text-left p-4 rounded-lg border-2 transition-all ${l?"border-blue-500 bg-blue-500/10":"border-gray-700 bg-gray-800 hover:border-gray-600"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center font-bold",style:{backgroundColor:n.color+"20",color:n.color},children:s==="aws"?"AWS":s==="google_workspace"?"G":s==="okta"?"O":s==="microsoft_security"?"ðŸ›¡":"M"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:n.name}),e.jsx("span",{className:"text-xs text-gray-400",children:n.setupType==="oauth"?"OAuth 2.0":"IAM Role"})]})]}),e.jsx("p",{className:"text-sm text-gray-400",children:n.description})]})}function E({values:s,onChange:l,onGenerateExternalId:a,generatingId:n}){const{data:t}=C(),[d,o]=x.useState(!1);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Integration Name *"}),e.jsx("input",{type:"text",value:s.name||"",onChange:i=>l("name",i.target.value),placeholder:"e.g., Production AWS Account",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"IAM Role ARN *"}),e.jsx("input",{type:"text",value:s.aws_role_arn||"",onChange:i=>l("aws_role_arn",i.target.value),placeholder:"arn:aws:iam::123456789012:role/OsirisCareAuditRole",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"The ARN of the IAM role we will assume to access your AWS account"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"External ID *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:s.aws_external_id||"",onChange:i=>l("aws_external_id",i.target.value),placeholder:"Click 'Generate' to create a secure ID",className:"flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"}),e.jsx("button",{type:"button",onClick:a,disabled:n,className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 disabled:opacity-50",children:n?"Generating...":"Generate"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"A unique ID to prevent confused deputy attacks. Include this in your role's trust policy."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Regions (comma-separated)"}),e.jsx("input",{type:"text",value:(s.aws_regions||["us-east-1"]).join(", "),onChange:i=>l("aws_regions",i.target.value.split(",").map(h=>h.trim()).filter(Boolean)),placeholder:"us-east-1, us-west-2",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"pt-4 border-t border-gray-700",children:[e.jsxs("button",{type:"button",onClick:()=>o(!d),className:"text-blue-400 hover:text-blue-300 text-sm flex items-center gap-1",children:[d?"Hide":"Show"," IAM Role Setup Instructions",e.jsx("svg",{className:`w-4 h-4 transition-transform ${d?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d&&t&&e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsx("h4",{className:"font-medium text-white mb-2",children:"Setup Instructions"}),e.jsx("pre",{className:"text-xs text-gray-300 whitespace-pre-wrap overflow-x-auto",children:t.instructions})]}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-white",children:"CloudFormation Template"}),e.jsx("button",{type:"button",onClick:()=>navigator.clipboard.writeText(t.cloudformation_template.replace("YOUR_EXTERNAL_ID_HERE",s.aws_external_id||"YOUR_EXTERNAL_ID_HERE")),className:"text-xs text-blue-400 hover:text-blue-300",children:"Copy"})]}),e.jsx("pre",{className:"text-xs text-gray-300 overflow-x-auto max-h-48 overflow-y-auto bg-gray-900 p-2 rounded",children:t.cloudformation_template.replace("YOUR_EXTERNAL_ID_HERE",s.aws_external_id||"YOUR_EXTERNAL_ID_HERE")})]})]})]})]})}function D({provider:s,values:l,onChange:a}){const n=m[s];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Integration Name *"}),e.jsx("input",{type:"text",value:l.name||"",onChange:t=>a("name",t.target.value),placeholder:`e.g., ${n.name} Production`,className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"OAuth Client ID *"}),e.jsx("input",{type:"text",value:l.oauth_client_id||"",onChange:t=>a("oauth_client_id",t.target.value),placeholder:"Client ID from your OAuth app",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"OAuth Client Secret *"}),e.jsx("input",{type:"password",value:l.oauth_client_secret||"",onChange:t=>a("oauth_client_secret",t.target.value),placeholder:"Client secret from your OAuth app",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),(s==="azure_ad"||s==="microsoft_security")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Tenant ID *"}),e.jsx("input",{type:"text",value:l.oauth_tenant_id||"",onChange:t=>a("oauth_tenant_id",t.target.value),placeholder:"Azure AD tenant ID (GUID)",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"})]}),s==="okta"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Okta Domain *"}),e.jsx("input",{type:"text",value:l.okta_domain||"",onChange:t=>a("okta_domain",t.target.value),placeholder:"yourcompany.okta.com",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),s==="google_workspace"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Customer ID (optional)"}),e.jsx("input",{type:"text",value:l.google_customer_id||"",onChange:t=>a("google_customer_id",t.target.value),placeholder:"my_customer (default)",className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:'Leave blank to use "my_customer" which refers to your own domain'})]}),e.jsxs("div",{className:"p-4 bg-blue-900/20 border border-blue-800 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-400 mb-2",children:"OAuth App Setup"}),e.jsxs("p",{className:"text-sm text-gray-300",children:[s==="google_workspace"&&e.jsxs(e.Fragment,{children:["Create an OAuth app in the Google Cloud Console with the Admin SDK API enabled. Required scopes: ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"admin.directory.user.readonly"}),","," ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"admin.directory.group.readonly"})]}),s==="azure_ad"&&e.jsxs(e.Fragment,{children:["Register an application in Azure AD with the Microsoft Graph API permissions. Required permissions: ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"User.Read.All"}),","," ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"Group.Read.All"}),","," ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"Policy.Read.All"})]}),s==="microsoft_security"&&e.jsxs(e.Fragment,{children:["Register an application in Azure AD with Microsoft Graph security permissions. Required: ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"SecurityEvents.Read.All"}),","," ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"DeviceManagementManagedDevices.Read.All"}),","," ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"Device.Read.All"})]}),s==="okta"&&e.jsxs(e.Fragment,{children:["Create an OAuth app in your Okta Admin Console with the Okta API scopes. Required scopes: ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"okta.users.read"}),","," ",e.jsx("code",{className:"text-xs bg-gray-800 px-1 rounded",children:"okta.groups.read"})]})]})]})]})}function F(){const{siteId:s}=v(),l=k(),[a,n]=x.useState("provider"),[t,d]=x.useState(null),[o,i]=x.useState({}),[h,u]=x.useState(null),p=A(),b=I();if(!s)return e.jsx("div",{className:"p-6 text-gray-400",children:"Site ID required"});const f=r=>{d(r),i({provider:r,aws_regions:["us-east-1"]})},y=(r,c)=>{i(_=>({..._,[r]:c}))},j=async()=>{try{const r=await b.mutateAsync();i(c=>({...c,aws_external_id:r.external_id}))}catch{u("Failed to generate external ID")}},w=async()=>{if(!t||!o.name){u("Please fill in all required fields");return}u(null);try{const r=await p.mutateAsync({siteId:s,data:{...o,provider:t}});if(r.auth_url)if(S(r.auth_url)){window.location.href=r.auth_url;return}else{u("Invalid OAuth redirect URL. Please contact support.");return}n("complete")}catch(r){u(r.message||"Failed to create integration")}},N=()=>!t||!o.name?!1:t==="aws"?!!(o.aws_role_arn&&o.aws_external_id):t==="azure_ad"||t==="microsoft_security"?!!(o.oauth_client_id&&o.oauth_client_secret&&o.oauth_tenant_id):t==="okta"?!!(o.oauth_client_id&&o.oauth_client_secret&&o.okta_domain):!!(o.oauth_client_id&&o.oauth_client_secret);return e.jsxs("div",{className:"min-h-screen bg-gray-900 p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-400 mb-1",children:[e.jsx(g,{to:"/sites",className:"hover:text-white",children:"Sites"}),e.jsx("span",{children:"/"}),e.jsx(g,{to:`/sites/${s}`,className:"hover:text-white",children:s}),e.jsx("span",{children:"/"}),e.jsx(g,{to:`/sites/${s}/integrations`,className:"hover:text-white",children:"Integrations"}),e.jsx("span",{children:"/"}),e.jsx("span",{className:"text-white",children:"Setup"})]}),e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Add Cloud Integration"})]}),e.jsx("div",{className:"flex items-center gap-4 mb-8",children:["provider","credentials","complete"].map((r,c)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-medium ${a===r?"bg-blue-600 text-white":c<["provider","credentials","complete"].indexOf(a)?"bg-green-600 text-white":"bg-gray-700 text-gray-400"}`,children:c+1}),e.jsx("span",{className:"ml-2 text-sm text-gray-400 capitalize",children:r}),c<2&&e.jsx("div",{className:"w-8 h-px bg-gray-700 mx-4"})]},r))}),h&&e.jsx("div",{className:"mb-6 p-4 bg-red-900/20 border border-red-800 rounded-lg",children:e.jsx("p",{className:"text-red-400",children:h})}),e.jsxs("div",{className:"max-w-2xl",children:[a==="provider"&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4",children:"Select Provider"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:Object.keys(m).map(r=>e.jsx(O,{provider:r,selected:t===r,onSelect:()=>f(r)},r))}),e.jsx("button",{onClick:()=>n("credentials"),disabled:!t,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Continue"})]}),a==="credentials"&&t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("button",{onClick:()=>n("provider"),className:"text-gray-400 hover:text-white",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsxs("h2",{className:"text-lg font-semibold text-white",children:["Configure ",m[t].name]})]}),t==="aws"?e.jsx(E,{values:o,onChange:y,onGenerateExternalId:j,generatingId:b.isPending}):e.jsx(D,{provider:t,values:o,onChange:y}),e.jsxs("div",{className:"mt-6 flex items-center gap-4",children:[e.jsx("button",{onClick:w,disabled:!N()||p.isPending,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:p.isPending?"Creating...":t==="aws"?"Test & Create":"Continue to OAuth"}),e.jsx("button",{onClick:()=>l(`/sites/${s}/integrations`),className:"px-4 py-2 text-gray-400 hover:text-white",children:"Cancel"})]})]}),a==="complete"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-xl font-semibold text-white mb-2",children:"Integration Created!"}),e.jsxs("p",{className:"text-gray-400 mb-6",children:["Your ",t&&m[t].name," integration has been configured. The initial sync will begin shortly."]}),e.jsx(g,{to:`/sites/${s}/integrations`,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 inline-block",children:"View Integrations"})]})]})]})}export{F as default};
