import{a4 as K,r as h,x as g,a5 as n,j as e,G as c,M as i}from"./index-ByrxzNCH.js";const R=({status:t})=>{const r={in_progress:"bg-accent-primary text-white",paused:"bg-health-warning text-white",completed:"bg-health-healthy text-white",failed:"bg-health-critical text-white",cancelled:"bg-fill-tertiary text-label-secondary",pending:"bg-fill-secondary text-label-primary"};return e.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${r[t]||r.pending}`,children:t.replace("_"," ")})},Q=({progress:t})=>{if(!t)return null;const r=t.total||1,o=t.succeeded/r*100,u=t.failed/r*100,x=t.in_progress/r*100;return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex h-2 rounded-full overflow-hidden bg-fill-tertiary",children:[e.jsx("div",{className:"bg-health-healthy",style:{width:`${o}%`}}),e.jsx("div",{className:"bg-accent-primary",style:{width:`${x}%`}}),e.jsx("div",{className:"bg-health-critical",style:{width:`${u}%`}})]}),e.jsxs("div",{className:"flex justify-between text-xs text-label-tertiary mt-1",children:[e.jsxs("span",{children:[t.succeeded," succeeded"]}),e.jsxs("span",{children:[t.pending," pending"]}),e.jsxs("span",{children:[t.failed," failed"]})]})]})},M=()=>{const t=K(),[r,o]=h.useState(!1),[u,x]=h.useState(!1),[N,p]=h.useState(null),[a,d]=h.useState({version:"",iso_url:"",sha256:"",release_notes:"",agent_version:""}),{data:l}=g({queryKey:["fleet-stats"],queryFn:()=>i.getStats(),refetchInterval:6e4,staleTime:3e4}),{data:y=[],isLoading:b}=g({queryKey:["fleet-releases"],queryFn:()=>i.getReleases(),refetchInterval:6e4,staleTime:3e4}),{data:m=[],isLoading:j}=g({queryKey:["fleet-rollouts"],queryFn:()=>i.getRollouts(),refetchInterval:3e4,staleTime:15e3}),f=n({mutationFn:s=>i.createRelease(s),onSuccess:()=>{t.invalidateQueries({queryKey:["fleet-releases"]}),t.invalidateQueries({queryKey:["fleet-stats"]}),o(!1),d({version:"",iso_url:"",sha256:"",release_notes:"",agent_version:""})}}),v=n({mutationFn:s=>i.createRollout({release_id:s,strategy:"staged",stages:[{percent:5,delay_hours:24},{percent:25,delay_hours:24},{percent:100,delay_hours:0}]}),onSuccess:()=>{t.invalidateQueries({queryKey:["fleet-rollouts"]}),t.invalidateQueries({queryKey:["fleet-stats"]}),x(!1),p(null)}}),C=n({mutationFn:s=>i.pauseRollout(s),onSuccess:()=>t.invalidateQueries({queryKey:["fleet-rollouts"]})}),S=n({mutationFn:s=>i.resumeRollout(s),onSuccess:()=>t.invalidateQueries({queryKey:["fleet-rollouts"]})}),k=n({mutationFn:s=>i.advanceRollout(s),onSuccess:()=>t.invalidateQueries({queryKey:["fleet-rollouts"]})}),w=n({mutationFn:s=>i.cancelRollout(s),onSuccess:()=>{t.invalidateQueries({queryKey:["fleet-rollouts"]}),t.invalidateQueries({queryKey:["fleet-stats"]})}}),q=n({mutationFn:s=>i.deleteRelease(s),onSuccess:()=>{t.invalidateQueries({queryKey:["fleet-releases"]}),t.invalidateQueries({queryKey:["fleet-stats"]})}}),F=n({mutationFn:s=>i.setLatest(s),onSuccess:()=>{t.invalidateQueries({queryKey:["fleet-releases"]}),t.invalidateQueries({queryKey:["fleet-stats"]})}});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(c,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-label-tertiary",children:"Latest Version"}),e.jsx("div",{className:"text-2xl font-bold text-accent-primary mt-1",children:(l==null?void 0:l.releases.latest_version)||"None"})]}),e.jsxs(c,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-label-tertiary",children:"Active Rollouts"}),e.jsx("div",{className:"text-2xl font-bold text-health-warning mt-1",children:(l==null?void 0:l.rollouts.in_progress)||0})]}),e.jsxs(c,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-label-tertiary",children:"30-Day Success Rate"}),e.jsxs("div",{className:"text-2xl font-bold text-health-healthy mt-1",children:[(l==null?void 0:l.appliance_updates_30d.success_rate)||0,"%"]})]}),e.jsxs(c,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-label-tertiary",children:"Updates (30d)"}),e.jsx("div",{className:"text-2xl font-bold text-label-primary mt-1",children:(l==null?void 0:l.appliance_updates_30d.total)||0})]})]}),e.jsxs(c,{children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("h2",{className:"text-lg font-semibold text-label-primary",children:"Active Rollouts"})}),j&&e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full animate-spin mx-auto"})}),!j&&m.filter(s=>s.status==="in_progress"||s.status==="paused").length===0&&e.jsx("div",{className:"text-center py-8 text-label-tertiary",children:"No active rollouts"}),!j&&m.filter(s=>s.status==="in_progress"||s.status==="paused").map(s=>{var _;return e.jsxs("div",{className:"border border-separator rounded-ios-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-label-primary",children:s.name||s.version}),e.jsx("span",{className:"ml-2",children:e.jsx(R,{status:s.status})})]}),e.jsxs("div",{className:"flex gap-2",children:[s.status==="in_progress"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>C.mutate(s.id),className:"px-3 py-1 text-sm bg-health-warning text-white rounded-ios-md hover:opacity-90",children:"Pause"}),e.jsx("button",{onClick:()=>k.mutate(s.id),className:"px-3 py-1 text-sm bg-accent-primary text-white rounded-ios-md hover:opacity-90",disabled:s.current_stage>=s.stages.length-1,children:"Advance Stage"}),e.jsx("button",{onClick:()=>{confirm("Cancel this rollout? Pending appliances will not be updated.")&&w.mutate(s.id)},className:"px-3 py-1 text-sm bg-health-critical text-white rounded-ios-md hover:opacity-90",children:"Cancel"})]}),s.status==="paused"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>S.mutate(s.id),className:"px-3 py-1 text-sm bg-health-healthy text-white rounded-ios-md hover:opacity-90",children:"Resume"}),e.jsx("button",{onClick:()=>{confirm("Cancel this rollout? Pending appliances will not be updated.")&&w.mutate(s.id)},className:"px-3 py-1 text-sm bg-health-critical text-white rounded-ios-md hover:opacity-90",children:"Cancel"})]})]})]}),e.jsxs("div",{className:"text-sm text-label-secondary mb-2",children:["Stage ",s.current_stage+1," of ",s.stages.length," (",(_=s.stages[s.current_stage])==null?void 0:_.percent,"%)"]}),e.jsx(Q,{progress:s.progress})]},s.id)})]}),e.jsxs(c,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-label-primary",children:"Releases"}),e.jsxs("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-accent-primary text-white rounded-ios-md hover:opacity-90 flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"New Release"]})]}),b&&e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full animate-spin mx-auto"})}),!b&&y.length===0&&e.jsx("div",{className:"text-center py-8 text-label-tertiary",children:"No releases yet. Create your first release to get started."}),!b&&y.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-sm text-label-tertiary border-b border-separator",children:[e.jsx("th",{className:"pb-2 font-medium",children:"Version"}),e.jsx("th",{className:"pb-2 font-medium",children:"Agent"}),e.jsx("th",{className:"pb-2 font-medium",children:"Size"}),e.jsx("th",{className:"pb-2 font-medium",children:"Created"}),e.jsx("th",{className:"pb-2 font-medium",children:"Status"}),e.jsx("th",{className:"pb-2 font-medium",children:"Actions"})]})}),e.jsx("tbody",{children:y.map(s=>e.jsxs("tr",{className:"border-b border-separator last:border-0",children:[e.jsxs("td",{className:"py-3",children:[e.jsx("span",{className:"font-medium text-label-primary",children:s.version}),s.is_latest&&e.jsx("span",{className:"ml-2 px-2 py-0.5 text-xs bg-health-healthy text-white rounded-full",children:"Latest"})]}),e.jsx("td",{className:"py-3 text-label-secondary",children:s.agent_version||"-"}),e.jsx("td",{className:"py-3 text-label-secondary",children:s.size_bytes?`${(s.size_bytes/1024/1024/1024).toFixed(1)} GB`:"-"}),e.jsx("td",{className:"py-3 text-label-secondary",children:new Date(s.created_at).toLocaleDateString()}),e.jsx("td",{className:"py-3",children:s.is_active?e.jsx("span",{className:"text-health-healthy",children:"Active"}):e.jsx("span",{className:"text-label-tertiary",children:"Inactive"})}),e.jsx("td",{className:"py-3",children:e.jsxs("div",{className:"flex gap-2",children:[!s.is_latest&&s.is_active&&e.jsx("button",{onClick:()=>F.mutate(s.version),className:"px-2 py-1 text-xs bg-fill-secondary text-label-primary rounded hover:bg-fill-tertiary",children:"Set Latest"}),e.jsx("button",{onClick:()=>{p(s.id),x(!0)},className:"px-2 py-1 text-xs bg-accent-primary text-white rounded hover:opacity-90",children:"Deploy"}),!s.is_latest&&e.jsx("button",{onClick:()=>{confirm(`Deactivate release ${s.version}? It will no longer be available for rollouts.`)&&q.mutate(s.version)},className:"px-2 py-1 text-xs bg-health-critical text-white rounded hover:opacity-90",children:"Remove"})]})})]},s.id))})]})})]}),e.jsxs(c,{children:[e.jsx("h2",{className:"text-lg font-semibold text-label-primary mb-4",children:"Rollout History"}),m.filter(s=>s.status!=="in_progress"&&s.status!=="paused").slice(0,10).map(s=>e.jsxs("div",{className:"flex items-center justify-between py-3 border-b border-separator last:border-0",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-label-primary",children:s.name||s.version}),e.jsx("span",{className:"ml-2",children:e.jsx(R,{status:s.status})}),e.jsx("div",{className:"text-sm text-label-tertiary",children:s.completed_at?new Date(s.completed_at).toLocaleString():"-"})]}),s.progress&&e.jsxs("div",{className:"text-right text-sm",children:[e.jsxs("div",{className:"text-health-healthy",children:[s.progress.succeeded," succeeded"]}),s.progress.failed>0&&e.jsxs("div",{className:"text-health-critical",children:[s.progress.failed," failed"]})]})]},s.id)),m.filter(s=>s.status!=="in_progress"&&s.status!=="paused").length===0&&e.jsx("div",{className:"text-center py-8 text-label-tertiary",children:"No rollout history yet"})]}),r&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-ios-xl p-6 w-full max-w-md shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold text-label-primary mb-4",children:"New Release"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-label-secondary mb-1",children:"Version"}),e.jsx("input",{type:"text",placeholder:"v44",value:a.version,onChange:s=>d({...a,version:s.target.value}),className:"w-full px-3 py-2 rounded-ios-md bg-fill-secondary text-label-primary border border-separator focus:border-accent-primary focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-label-secondary mb-1",children:"ISO URL"}),e.jsx("input",{type:"text",placeholder:"https://updates.osiriscare.net/v44.iso",value:a.iso_url,onChange:s=>d({...a,iso_url:s.target.value}),className:"w-full px-3 py-2 rounded-ios-md bg-fill-secondary text-label-primary border border-separator focus:border-accent-primary focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-label-secondary mb-1",children:"SHA256 Checksum"}),e.jsx("input",{type:"text",placeholder:"abc123...",value:a.sha256,onChange:s=>d({...a,sha256:s.target.value}),className:"w-full px-3 py-2 rounded-ios-md bg-fill-secondary text-label-primary border border-separator focus:border-accent-primary focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-label-secondary mb-1",children:"Agent Version"}),e.jsx("input",{type:"text",placeholder:"1.0.44",value:a.agent_version,onChange:s=>d({...a,agent_version:s.target.value}),className:"w-full px-3 py-2 rounded-ios-md bg-fill-secondary text-label-primary border border-separator focus:border-accent-primary focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-label-secondary mb-1",children:"Release Notes"}),e.jsx("textarea",{placeholder:"What's new in this release...",value:a.release_notes,onChange:s=>d({...a,release_notes:s.target.value}),className:"w-full px-3 py-2 rounded-ios-md bg-fill-secondary text-label-primary border border-separator focus:border-accent-primary focus:outline-none h-24 resize-none"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{onClick:()=>o(!1),className:"px-4 py-2 text-label-secondary hover:text-label-primary",children:"Cancel"}),e.jsx("button",{onClick:()=>f.mutate(a),disabled:!a.version||!a.iso_url||!a.sha256||f.isPending,className:"px-4 py-2 bg-accent-primary text-white rounded-ios-md hover:opacity-90 disabled:opacity-50",children:f.isPending?"Creating...":"Create Release"})]})]})}),u&&N&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-ios-xl p-6 w-full max-w-md shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold text-label-primary mb-4",children:"Start Rollout"}),e.jsx("p",{className:"text-label-secondary mb-4",children:"This will start a staged rollout to all online appliances:"}),e.jsxs("div",{className:"space-y-2 mb-6",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-label-tertiary",children:"Stage 1 (Canary)"}),e.jsx("span",{className:"text-label-primary",children:"5% of fleet, 24h wait"})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-label-tertiary",children:"Stage 2"}),e.jsx("span",{className:"text-label-primary",children:"25% of fleet, 24h wait"})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-label-tertiary",children:"Stage 3 (Full)"}),e.jsx("span",{className:"text-label-primary",children:"100% of fleet"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{x(!1),p(null)},className:"px-4 py-2 text-label-secondary hover:text-label-primary",children:"Cancel"}),e.jsx("button",{onClick:()=>v.mutate(N),disabled:v.isPending,className:"px-4 py-2 bg-accent-primary text-white rounded-ios-md hover:opacity-90 disabled:opacity-50",children:v.isPending?"Starting...":"Start Rollout"})]})]})})]})};export{M as FleetUpdates,M as default};
