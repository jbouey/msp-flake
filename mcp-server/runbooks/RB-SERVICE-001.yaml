id: RB-SERVICE-001
name: "Service Crash Remediation"
description: "Automatically restart and recover crashed systemd services"
hipaa_controls:
  - "164.308(a)(7)(ii)(C)"  # Contingency Plan - Emergency Mode Operation Plan
  - "164.312(a)(1)"  # Access Control - Automatic Logoff
severity: high
category: availability

steps:
  - id: 1
    action: identify_failed_service
    description: "Detect which service failed"
    timeout: 10
    command: "systemctl list-units --state=failed --no-pager"
    parse_output: true

  - id: 2
    action: check_service_logs
    description: "Review logs for crash reason"
    timeout: 30
    command: "journalctl -u ${SERVICE_NAME} -n 50 --no-pager"
    capture_output: true

  - id: 3
    action: check_port_conflicts
    description: "Ensure required ports are available"
    timeout: 10
    command: "netstat -tlnp | grep ${SERVICE_PORT}"
    failure_is_success: true  # Port should be free

  - id: 4
    action: restart_service
    description: "Attempt service restart"
    timeout: 60
    command: "systemctl restart ${SERVICE_NAME}"
    wait_for_active: true
    max_wait_seconds: 30

  - id: 5
    action: verify_service_health
    description: "Confirm service is responding"
    timeout: 30
    command: "systemctl is-active ${SERVICE_NAME}"
    success_condition: "output == 'active'"

  - id: 6
    action: test_service_endpoint
    description: "Test service HTTP endpoint if applicable"
    timeout: 10
    command: "curl -f http://localhost:${SERVICE_PORT}/health"
    optional: true

rollback:
  - action: stop_service
    command: "systemctl stop ${SERVICE_NAME}"
  - action: alert_administrator
    command: "echo 'Service ${SERVICE_NAME} failed to restart' | mail -s 'URGENT: Service Failure' admin@clinic.local"

evidence_required:
  - service_name
  - crash_logs
  - restart_timestamp
  - service_status_after
  - health_check_result

output_format:
  type: "json"
  schema:
    incident_id: "string"
    runbook_id: "string"
    service_name: "string"
    restart_count: "integer"
    outcome: "success|failure"
