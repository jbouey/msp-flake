id: RB-CERT-001
name: "Certificate Expiry Remediation"
description: "Automatically renew expiring SSL/TLS certificates"
hipaa_controls:
  - "164.312(e)(1)"  # Transmission Security
  - "164.312(a)(2)(iv)"  # Encryption and Decryption
severity: medium
category: encryption

steps:
  - id: 1
    action: check_certificate_expiry
    description: "Check certificate expiration date"
    timeout: 10
    command: "openssl x509 -in /etc/ssl/certs/server.crt -noout -enddate"
    parse_output: true

  - id: 2
    action: backup_existing_cert
    description: "Backup current certificate before renewal"
    timeout: 10
    command: "cp /etc/ssl/certs/server.crt /etc/ssl/certs/server.crt.backup-$(date +%Y%m%d)"

  - id: 3
    action: renew_certificate
    description: "Request new certificate from Let's Encrypt"
    timeout: 60
    command: "certbot renew --force-renewal"
    retry_on_failure: true
    max_retries: 3

  - id: 4
    action: reload_web_server
    description: "Reload web server to use new certificate"
    timeout: 30
    command: "systemctl reload nginx"
    verify_service_active: true

  - id: 5
    action: verify_new_certificate
    description: "Confirm new certificate is valid"
    timeout: 10
    command: "openssl x509 -in /etc/ssl/certs/server.crt -noout -enddate"
    success_condition: "expiry_date > 30_days_from_now"

rollback:
  - action: restore_backup_certificate
    command: "mv /etc/ssl/certs/server.crt.backup-* /etc/ssl/certs/server.crt"
  - action: reload_web_server
    command: "systemctl reload nginx"

evidence_required:
  - old_cert_expiry_date
  - new_cert_expiry_date
  - renewal_logs
  - nginx_reload_status
  - verification_result

output_format:
  type: "json"
  schema:
    incident_id: "string"
    runbook_id: "string"
    old_expiry: "datetime"
    new_expiry: "datetime"
    outcome: "success|failure"
