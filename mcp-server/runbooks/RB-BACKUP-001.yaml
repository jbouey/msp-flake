id: RB-BACKUP-001
name: "Backup Failure Remediation"
description: "Automatically diagnose and fix backup failures"
hipaa_controls:
  - "164.308(a)(7)(ii)(A)"  # Contingency Plan - Data Backup Plan
  - "164.310(d)(2)(iv)"     # Device and Media Controls - Data Backup and Storage
severity: high
category: data_protection

steps:
  - id: 1
    action: check_backup_logs
    description: "Review backup logs for error messages"
    timeout: 30
    command: "journalctl -u restic-backup -n 100 --no-pager"
    success_pattern: "backup finished successfully"
    failure_pattern: "error|failed|timeout"

  - id: 2
    action: verify_disk_space
    description: "Ensure sufficient disk space for backup"
    timeout: 10
    command: "df -h /backup"
    success_condition: "available > 10GB"

  - id: 3
    action: check_backup_repository
    description: "Verify backup repository is accessible"
    timeout: 30
    command: "restic -r /backup/repo check --no-lock"
    retry_on_failure: true
    max_retries: 2

  - id: 4
    action: restart_backup_service
    description: "Restart backup service if hung"
    timeout: 60
    command: "systemctl restart restic-backup"
    wait_for_active: true

  - id: 5
    action: trigger_manual_backup
    description: "Force immediate backup run"
    timeout: 300
    command: "systemctl start restic-backup"
    verify_completion: true

rollback:
  - action: alert_administrator
    description: "Send alert if automated fix fails"
    command: "echo 'Backup remediation failed' | mail -s 'URGENT: Backup Failure' admin@clinic.local"

evidence_required:
  - backup_log_excerpt
  - disk_usage_before
  - disk_usage_after
  - service_status
  - backup_completion_hash
  - remediation_timestamp

output_format:
  type: "json"
  schema:
    incident_id: "string"
    runbook_id: "string"
    steps_executed: "array"
    outcome: "success|failure|partial"
    evidence_bundle_hash: "string"
    duration_seconds: "integer"
