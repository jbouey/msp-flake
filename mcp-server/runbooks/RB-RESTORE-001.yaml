id: RB-RESTORE-001
name: "Backup Restore Test"
description: "Weekly automated backup restore verification"
hipaa_controls:
  - "164.308(a)(7)(ii)(A)"  # Contingency Plan - Data Backup Plan
  - "164.310(d)(2)(iv)"  # Device and Media Controls - Data Backup and Storage
severity: medium
category: data_protection
schedule: "0 2 * * 0"  # Sunday 2 AM

steps:
  - id: 1
    action: select_random_backup
    description: "Choose recent backup to test"
    timeout: 10
    command: "restic -r /backup/repo snapshots --json | jq -r '.[0].id'"
    parse_output: true

  - id: 2
    action: create_scratch_directory
    description: "Create temporary restore location"
    timeout: 10
    command: "mktemp -d /tmp/restore-test-XXXXXX"
    capture_output: true

  - id: 3
    action: restore_sample_files
    description: "Restore random sample of files"
    timeout: 600
    command: "restic -r /backup/repo restore ${SNAPSHOT_ID} --target ${RESTORE_DIR} --path /etc"
    verify_completion: true

  - id: 4
    action: verify_file_integrity
    description: "Check restored files match original checksums"
    timeout: 120
    command: "find ${RESTORE_DIR} -type f -exec sha256sum {} \; > ${RESTORE_DIR}/checksums.txt"
    compare_with_source: true

  - id: 5
    action: test_file_readability
    description: "Ensure files are readable and not corrupted"
    timeout: 60
    command: "find ${RESTORE_DIR} -type f -exec file {} \;"
    success_condition: "no_errors"

  - id: 6
    action: cleanup_scratch_directory
    description: "Remove test restore files"
    timeout: 30
    command: "rm -rf ${RESTORE_DIR}"
    always_run: true

rollback:
  - action: cleanup_scratch_directory
    command: "rm -rf ${RESTORE_DIR}"

evidence_required:
  - snapshot_id
  - files_restored
  - checksum_verification
  - restore_duration_seconds
  - test_timestamp
  - verification_result

output_format:
  type: "json"
  schema:
    incident_id: "string"
    runbook_id: "string"
    snapshot_tested: "string"
    files_verified: "integer"
    checksum_match: "boolean"
    outcome: "success|failure"
